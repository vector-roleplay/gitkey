name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      # ========== 缓存配置 ==========
      
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-
      
      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            pub-
      
      # ========== Flutter 配置 ==========
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true  # 启用 Flutter SDK 缓存
      
      - name: Create Flutter project
        run: |
          cp -r lib /tmp/lib_backup
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' -exec rm -rf {} +
          flutter create --org com.example --project-name ai_code_sync --platforms android .
          rm -rf lib
          cp -r /tmp/lib_backup lib
          
      - name: Update pubspec.yaml
        run: |
          cat > pubspec.yaml << 'EOF'
          name: ai_code_sync
          description: AI Code Sync
          publish_to: 'none'
          version: 1.0.0+1
          
          environment:
            sdk: ^3.0.0
          
          dependencies:
            flutter:
              sdk: flutter
            flutter_localizations:
              sdk: flutter
            http: any
            shared_preferences: any
            provider: any
            cupertino_icons: any
            file_picker: any
            path_provider: any
            permission_handler: any
            archive: any
            open_filex: any
            background_downloader: any
          
          dev_dependencies:


            flutter_test:
              sdk: flutter
            flutter_lints: any
          
          flutter:
            uses-material-design: true
          EOF
          
      - name: Add permissions
        run: |
          # 添加网络权限
          sed -i '/<manifest xmlns/a\    <uses-permission android:name="android.permission.INTERNET"/>' android/app/src/main/AndroidManifest.xml
          # 添加存储权限（用于中转站功能）
          sed -i '/<uses-permission android:name="android.permission.INTERNET"/a\    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>' android/app/src/main/AndroidManifest.xml
          sed -i '/<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/a\    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>' android/app/src/main/AndroidManifest.xml
          sed -i '/<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/a\    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>' android/app/src/main/AndroidManifest.xml
          # 添加安装 APK 权限
          sed -i '/<uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/a\    <uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/>' android/app/src/main/AndroidManifest.xml
          # 添加通知权限（Android 13+ 后台下载需要）
          sed -i '/<uses-permission android:name="android.permission.REQUEST_INSTALL_PACKAGES"/a\    <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>' android/app/src/main/AndroidManifest.xml
          # 添加前台服务权限（后台下载需要）
          sed -i '/<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/a\    <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>' android/app/src/main/AndroidManifest.xml
          # 添加 requestLegacyExternalStorage 用于 Android 10 兼容
          sed -i 's/<application/<application android:requestLegacyExternalStorage="true"/' android/app/src/main/AndroidManifest.xml

      
      - name: Setup Keystore
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "使用已保存的密钥"
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
          else
            echo "生成新密钥"
            keytool -genkey -v \
              -keystore android/app/upload-keystore.jks \
              -storetype JKS \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -alias upload \
              -storepass android \
              -keypass android \
              -dname "CN=AI Code Sync, OU=Dev, O=Dev, L=City, ST=State, C=US"
            
            echo "=========================================="
            echo "首次运行请保存以下内容到 GitHub Secrets"
            echo "名称: KEYSTORE_BASE64"
            echo "值:"
            base64 -w 0 android/app/upload-keystore.jks
            echo ""
            echo "=========================================="
          fi
            
      - name: Configure signing
        run: |
          cat > android/key.properties << 'EOF'
          storePassword=android
          keyPassword=android
          keyAlias=upload
          storeFile=upload-keystore.jks
          EOF
          
          cat > android/app/build.gradle << 'EOF'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }

          def keystoreProperties = new Properties()
          def keystorePropertiesFile = rootProject.file('key.properties')
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
          }

          android {
              namespace = "com.example.ai_code_sync"
              compileSdk = flutter.compileSdkVersion
              ndkVersion = flutter.ndkVersion

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_1_8
                  targetCompatibility = JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = JavaVersion.VERSION_1_8
              }

              signingConfigs {
                  release {
                      keyAlias keystoreProperties['keyAlias']
                      keyPassword keystoreProperties['keyPassword']
                      storeFile file(keystoreProperties['storeFile'])
                      storePassword keystoreProperties['storePassword']
                  }
              }

              defaultConfig {
                  applicationId = "com.example.ai_code_sync"
                  minSdk = 21
                  targetSdk = flutter.targetSdkVersion
                  versionCode = flutter.versionCode
                  versionName = flutter.versionName
              }

              buildTypes {
                  release {
                      signingConfig = signingConfigs.release
                  }
                  debug {
                      signingConfig = signingConfigs.release
                  }
              }
          }

          flutter {
              source = "../.."
          }
          EOF

      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK
        run: |
          if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
            flutter build apk --release --target-platform android-arm64
          else
            flutter build apk --debug --target-platform android-arm64
          fi
      
      # 清理旧的 artifacts，只保留最近 9 个（上传新的后变成 10 个）
      - name: Clean old artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching artifacts..."
          
          # 获取所有 artifacts
          artifacts=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq '.artifacts | sort_by(.created_at) | reverse | .[].id')
          
          # 转换为数组
          artifact_ids=($artifacts)
          count=${#artifact_ids[@]}
          
          echo "Found $count artifacts"
          
          # 如果超过 9 个，删除多余的（保留 9 个，加上即将上传的 1 个 = 10 个）
          if [ "$count" -gt 9 ]; then
            echo "Cleaning up old artifacts..."
            
            # 从第 10 个开始删除
            for ((i=9; i<count; i++)); do
              id=${artifact_ids[$i]}
              echo "Deleting artifact ID: $id"
              gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id || true
            done
            
            echo "Cleanup complete!"
          else
            echo "No cleanup needed"
          fi
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ github.event.inputs.build_type }}
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30


